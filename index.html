<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Advice Board</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    // Import Firebase modules
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, getDoc, getDocs, serverTimestamp, 
            query, where, orderBy, onSnapshot, limit, startAfter } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    
  const firebaseConfig = {
    apiKey: "AIzaSyC8i6009Q7MF8jKBk88-akVRUVhhuBVHSU",
    authDomain: "advice-ad042.firebaseapp.com",
    projectId: "advice-ad042",
    storageBucket: "advice-ad042.firebasestorage.app",
    messagingSenderId: "677646026777",
    appId: "1:677646026777:web:8dd79e190d4d273b9fc288",
    measurementId: "G-1BKY784SFB"
  };

  // Initialize Firebase
  let app;
  try {
    app = getApp();
  } catch (e) {
    app = initializeApp(firebaseConfig);
  }
  const db = getFirestore(app);
  const auth = getAuth(app);
  const adviceList = document.getElementById('advice-list');
  const loginSection = document.getElementById("login-section");
  const loggedInSection = document.getElementById("logged-in-section");
  const userInfo = document.getElementById("user-info");
  const logoutBtn = document.getElementById("logout-btn");
  const openBtn = document.getElementById("open-add-advice");
  const modal = document.getElementById("advice-modal");
  const closeBtn = document.getElementById("close-modal");
  const filters = document.getElementById("filters");
  let unsubscribe = null;
  let lastVisible = null;
  let filteredDocs = [];
  let currentPage = 0;
  const PAGE_SIZE = 10;
  let currentQuery = null;
  let currentUser = null;
  let currentCategory = "";
  let editingAdviceId = null;

const filterMy = document.getElementById("filter-my");
const filterBookmarked = document.getElementById("filter-bookmarked");
[filterMy, filterBookmarked].forEach(el => {
  el.addEventListener("change", () => applyFilters());
});

async function applyFilters() {
  if (!currentUser) {
    adviceList.innerHTML = "<p>Please log in to view advice.</p>";
    return;
  }

  const showMine = filterMy.checked;
  const showBookmarked = filterBookmarked.checked;

  // Load all advice
  const adviceRef = collection(db, "advice");
  const allSnap = await getDocs(adviceRef);
  let adviceDocs = allSnap.docs;

  // Apply "Added By Me"
  if (showMine) {
    adviceDocs = adviceDocs.filter(d => d.data().authorId === currentUser.uid);
  }

  // Apply "Bookmarked"
  if (showBookmarked) {
    const bookmarksRef = collection(db, "users", currentUser.uid, "bookmarks");
    const bookmarkSnap = await getDocs(bookmarksRef);
    const bookmarkedIds = bookmarkSnap.docs.map(b => b.id);
    adviceDocs = adviceDocs.filter(d => bookmarkedIds.includes(d.id));
  }

  // Apply category (from selected link)
  if (currentCategory) {
    adviceDocs = adviceDocs.filter(d => d.data().category === currentCategory);
  }

  filteredDocs = adviceDocs;
  currentPage = 0;
  renderPaginatedAdvice();
}

function attachStarListeners(container, adviceId, userId, userName) {
  container.querySelectorAll(".star").forEach(star => {
    star.addEventListener("click", async () => {
      const rating = parseInt(star.dataset.value);
      
      // Update the visual state immediately
      updateStars(container, rating);
      
      // Save to Firestore (non-blocking UI)
      const comment = container.closest(".feedback-section").querySelector(".comment-input").value.trim();
      try {
        await saveFeedback(adviceId, userId, rating, comment, userName);
        console.log(`Saved rating ${rating} for ${adviceId}`);
      } catch (err) {
        console.error("Error saving feedback:", err);
      }
    });
  });
}

function calculateAverageRating(feedbackList) {
  const ratings = feedbackList
    .map(f => f.rating)
    .filter(r => typeof r === 'number');
  if (!ratings.length) return 0;
  return ratings.reduce((a,b) => a+b, 0) / ratings.length;
}

document.getElementById("close-modal").onclick = closeModal;

function closeModal() {
  document.getElementById("advice-modal").style.display = "none";

  // Reset to Add mode
  document.getElementById("modal-title").textContent = "Add Advice";
  document.getElementById("submit-advice-btn").textContent = "Add Advice";

  // Clear fields
  document.getElementById("advice-title").value = "";
  document.getElementById("advice-content").value = "";
  document.getElementById("advice-author").value = "";
  document.getElementById("advice-category").value = "";
  editingAdviceId = null;
}

function createStarElements(container, currentRating = 0) {
  container.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const star = document.createElement("span");
    star.classList.add("star");
    star.textContent = "‚òÖ";
    if (i <= currentRating) star.classList.add("selected");
    star.dataset.value = i;
    container.appendChild(star);
  }
}

// üß† Load advice (filtered or not)
async function loadAdvice(user, viewMode = "all", category = null) {
  if (unsubscribe) unsubscribe(); // stop previous listener

  let q;
  if (viewMode === "my" && user) {
    q = query(
      collection(db, "advice"),
      where("authorId", "==", user.uid),
      orderBy("timestamp", "desc")
    );
  } else if (viewMode === "bookmarked" && user) {
    // Load bookmarked advice IDs
    const bookmarksRef = collection(db, "users", user.uid, "bookmarks");
    const bookmarkSnap = await getDocs(bookmarksRef);
    const bookmarkedIds = bookmarkSnap.docs.map((d) => d.id);

    if (bookmarkedIds.length === 0) {
      adviceList.innerHTML = "<p>No bookmarked advice yet.</p>";
      return;
    }

    // Firestore can only handle up to 10 items in an 'in' query
    const chunks = [];
    for (let i = 0; i < bookmarkedIds.length; i += 10) {
      chunks.push(bookmarkedIds.slice(i, i + 10));
    }

    adviceList.innerHTML = "";
    chunks.forEach((chunk) => {
      const qChunk = query(
        collection(db, "advice"),
        where("__name__", "in", chunk),
        orderBy("timestamp", "desc")
      );
      onSnapshot(qChunk, (snapshot) => renderAdvice(snapshot, user));
    });
    return;
  } else if (viewMode === "category" && category) {
    q = query(
      collection(db, "advice"),
      where("category", "==", category),
      orderBy("timestamp", "desc")
    );
  } else {
    q = query(collection(db, "advice"), orderBy("timestamp", "desc"));
  }

  q = query(q, limit(10)); // limit to 10 per load
  unsubscribe = onSnapshot(q, (snapshot) => {
    renderAdvice(snapshot, user);
    if (snapshot.docs.length > 0) {
      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      currentQuery = q;
    }
  });
}

async function loadCategories() {
  const categoryLinksDiv = document.getElementById("category-links");
  const adviceRef = collection(db, "advice");

  try {
    const snapshot = await getDocs(adviceRef);
    const categories = new Set();

    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.category && data.category.trim() !== "") {
        categories.add(data.category.trim());
      }
    });

    // Sort categories alphabetically
    const sortedCategories = Array.from(categories).sort((a, b) => a.localeCompare(b));

    // Always include an "All" link first
    categoryLinksDiv.innerHTML = `<a href="#" class="category-link" data-category="">All</a>`;

    // Add category links
    sortedCategories.forEach(cat => {
      const a = document.createElement("a");
      a.href = "#";
      a.textContent = cat;
      a.classList.add("category-link");
      a.dataset.category = cat;
      categoryLinksDiv.appendChild(a);
    });

    // Attach click handlers
    document.querySelectorAll(".category-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();

        // Highlight active link
        document.querySelectorAll(".category-link").forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        // Update global category and reapply filters
        currentCategory = link.dataset.category;
        applyFilters();
      });
    });

  } catch (e) {
    console.error("Error loading categories:", e);
  }
}

async function loadFeedback(adviceId) {
  const feedbackCol = collection(db, "advice", adviceId, "feedback");
  const snapshot = await getDocs(feedbackCol);
  return snapshot.docs.map(doc => doc.data());
}

async function loadMoreAdvice() {
  currentPage++;
  renderPaginatedAdvice();
}

// üß± Render advice list
async function renderAdvice(snapshot, user) {
  adviceList.innerHTML = "";
  if (snapshot.empty) {
    adviceList.innerHTML = "<p>No advice found.</p>";
    return;
  }

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    const adviceId = docSnap.id;
    const isMine = user && data.authorId === user.uid;
    let isBookmarked = false;

    if (user) {
      const bookmarkRef = doc(db, "users", user.uid, "bookmarks", adviceId);
      const bookmarkSnap = await getDoc(bookmarkRef);
      isBookmarked = bookmarkSnap.exists();
    }

    const item = document.createElement("div");
    item.classList.add("advice-item");
    item.innerHTML = `
      <h3>${data.title}</h3>
      <p>${data.content}</p>
      <p><em>‚Äì ${data.author || "Anonymous"}</em></p>
      <p class="category-label" data-category="${data.category || 'Uncategorized'}">
        ${data.category || "Uncategorized"}
      </p>
      ${isMine ? "<p style='color: green; font-weight: bold;'>(Your advice)</p>" : ""}
      <button class="bookmark-btn" data-id="${adviceId}">
        ${isBookmarked ? "‚≠ê Bookmarked" : "‚òÜ Bookmark"}
      </button>
      <button class="edit-btn" data-id="${adviceId}">‚úé Edit</button>
      <button class="delete-btn" data-id="${adviceId}">üóëÔ∏è Delete</button>
      <div class="feedback-section" data-advice-id="${adviceId}">
        <div class="stars"></div>
        <textarea class="comment-input" placeholder="Leave a comment..."></textarea>
        <button class="save-feedback-btn">Save</button>
        <div class="avg-rating"></div>
        <div class="comments-list"></div>
      </div>
      <hr>
    `;
    adviceList.appendChild(item);
    const feedbackSection = item.querySelector(".feedback-section");
    const starsContainer = feedbackSection.querySelector(".stars");
    createStarElements(starsContainer);
    attachStarListeners(starsContainer, adviceId, user?.uid, user?.displayName || "Anonymous");
    showFeedback(adviceId, feedbackSection);
  }

  // Attach listeners to all bookmark buttons
  document.querySelectorAll(".bookmark-btn").forEach((btn) => {
    btn.addEventListener("click", () => toggleBookmark(user, btn.dataset.id, btn));
  });

  // Attach listeners to all edit buttons
  document.querySelectorAll(".edit-btn").forEach((button) => {
    button.addEventListener("click", async (e) => {
      const adviceDiv = e.target.closest(".advice-item");
      const adviceId = e.target.dataset.id;

      // Retrieve current advice data from Firestore to ensure it's up to date
      const adviceRef = doc(db, "advice", adviceId);
      const adviceSnap = await getDoc(adviceRef);
      const data = adviceSnap.data();

      if (!data) {
        alert("Could not load this advice item.");
        return;
      }

      // ‚úÖ Populate modal fields
      document.getElementById("advice-title").value = data.title || "";
      document.getElementById("advice-content").value = data.content || "";
      document.getElementById("advice-author").value = data.author || "";
      document.getElementById("advice-category").value = data.category || "";

      // ‚úÖ Switch modal into edit mode
      editingAdviceId = adviceId;
      document.getElementById("modal-title").textContent = "Edit Advice";
      document.getElementById("submit-advice-btn").textContent = "Update Advice";

      // ‚úÖ Show the modal and focus the title
      document.getElementById("advice-modal").style.display = "block";
      document.getElementById("advice-title").focus();
    });
  });

  // Attach listeners to all delete buttons
  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!user) {
        alert("You must be logged in to delete advice.");
        return;
      }

      const adviceId = btn.dataset.id;
      if (!confirm("Are you sure you want to delete this advice?")) return;

      try {
        await deleteDoc(doc(db, "advice", adviceId));
        loadAdvice(user); // refresh list
      } catch (err) {
        console.error("Error deleting advice:", err);
        alert("Error deleting advice. See console for details.");
      }
    });
  });
  const loadMoreBtn = document.getElementById("load-more-btn");
  if (loadMoreBtn) {
    loadMoreBtn.style.display =
      snapshot.docs.length === 10 ? "inline-block" : "none";
  }
    // üè∑Ô∏è Clickable category filter
  document.querySelectorAll(".category-label").forEach(label => {
    label.addEventListener("click", () => {
      const category = label.dataset.category;
      currentCategory = category === "Uncategorized" ? "" : category;

      // Highlight the matching category link in the sidebar (if it exists)
      document.querySelectorAll(".category-link").forEach(link => {
        link.classList.toggle("active", link.dataset.category === currentCategory);
      });

      // Apply filters with that category
      applyFilters();
    });
  });
}

async function renderAdviceFromDocs(docArray) {
  adviceList.innerHTML = "";
  if (!docArray.length) {
    adviceList.innerHTML = "<p>No advice found.</p>";
    return;
  }

  for (const docSnap of docArray) {
    const data = docSnap.data();
    const adviceId = docSnap.id;
    const item = document.createElement("div");
    item.classList.add("advice-item");
    item.innerHTML = `
      <h3>${data.title}</h3>
      <p>${data.content}</p>
      <p><em>‚Äì ${data.author || "Anonymous"}</em></p>
      <p class="category-label" data-category="${data.category || 'Uncategorized'}">
        ${data.category || "Uncategorized"}
      </p>
      <button class="bookmark-btn" data-id="${adviceId}">‚òÜ Bookmark</button>
      <button class="edit-btn" data-id="${adviceId}">‚úé Edit</button>
      <button class="delete-btn" data-id="${adviceId}">üóëÔ∏è Delete</button>
      <div class="feedback-section" data-advice-id="${adviceId}">
        <div class="stars"></div>
        <textarea class="comment-input" placeholder="Leave a comment..."></textarea>
        <button class="save-feedback-btn">Save</button>
        <div class="avg-rating"></div>
        <div class="comments-list"></div>
      </div>
      <hr>
    `;
    adviceList.appendChild(item);
    const feedbackSection = item.querySelector(".feedback-section");
    const starsContainer = feedbackSection.querySelector(".stars");
    createStarElements(starsContainer);
    attachStarListeners(starsContainer, adviceId, currentUser?.uid, currentUser?.displayName || "Anonymous");
    showFeedback(adviceId, feedbackSection);
  }

  // attach listeners to bookmark, edit, delete buttons again
  document.querySelectorAll(".bookmark-btn").forEach((btn) => {
    btn.addEventListener("click", () => toggleBookmark(currentUser, btn.dataset.id, btn));
  });

  document.querySelectorAll(".edit-btn").forEach((button) => {
  button.addEventListener("click", (e) => {
    const adviceDiv = e.target.closest(".advice-item");
    const adviceId = e.target.dataset.id;

    // Retrieve current advice data (if you already have it locally)
    const title = adviceDiv.querySelector("h3").textContent;
    const content = adviceDiv.querySelector("p").textContent;
    const author = adviceDiv.querySelector("em").textContent.substring(2);
    const category = adviceDiv.querySelector(".category-label")?.textContent.trim() || "Uncategorized";

    // Populate modal fields
    document.getElementById("advice-title").value = title;
    document.getElementById("advice-content").value = content;
    document.getElementById("advice-author").value = author;
    document.getElementById("advice-category").value = category;

    // Set modal state for editing
    document.getElementById("modal-title").textContent = "Edit Advice";
    const submitBtn = document.getElementById("submit-advice-btn");
    submitBtn.textContent = "Update Advice";
    submitBtn.onclick = () => updateAdvice(adviceId);

    // Show the modal
    document.getElementById("advice-modal").style.display = "block";
    document.getElementById("advice-title").focus();
  });
});

  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this advice?")) {
        await deleteDoc(doc(db, "advice", btn.dataset.id));
        applyFilters(); // refresh list
      }
    });
  });
    // üè∑Ô∏è Clickable category filter
  document.querySelectorAll(".category-label").forEach(label => {
    label.addEventListener("click", () => {
      const category = label.dataset.category;
      currentCategory = category === "Uncategorized" ? "" : category;

      // Highlight the matching category link in the sidebar (if it exists)
      document.querySelectorAll(".category-link").forEach(link => {
        link.classList.toggle("active", link.dataset.category === currentCategory);
      });
      
      // Apply filters with that category
      applyFilters();
    });
  });
}

function renderPaginatedAdvice() {
  const start = currentPage * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageDocs = filteredDocs.slice(start, end);
  renderAdviceFromDocs(pageDocs);
  
  // Show/hide Load More button
  const loadMoreBtn = document.getElementById("load-more-btn");
  if (end < filteredDocs.length) {
    loadMoreBtn.style.display = "inline-block";
  } else {
    loadMoreBtn.style.display = "none";
  }
}

async function saveFeedback(adviceId, userId, rating, comment, userName) {
  const feedbackRef = doc(db, "advice", adviceId, "feedback", userId);
  const data = {
    userId,
    userName,
    timestamp: serverTimestamp()
  };
  if (rating !== null && rating !== undefined) data.rating = rating;
  if (comment) data.comment = comment;

  await setDoc(feedbackRef, data, { merge: true });
}

async function showFeedback(adviceId, container) {
  const feedbackList = await loadFeedback(adviceId);
  
  if (!feedbackList.length) {
    container.querySelector(".avg-rating").textContent = "No ratings yet";
    return;
  }

  // Show average
  const ratings = feedbackList.filter(f => typeof f.rating === "number").map(f => f.rating);
  const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : "‚Äì";
  container.querySelector(".avg-rating").textContent = `Average: ${avg}`;

  // Show comments
  const commentsDiv = container.querySelector(".comments-list");
  commentsDiv.innerHTML = feedbackList
    .filter(f => f.comment)
    .map(f => `<p><strong>${f.userName || "Anon"}:</strong> ${f.comment}</p>`)
    .join("");

  // Show user's rating (if logged in)
  const userFeedback = feedbackList.find(f => f.userId === currentUser?.uid);
  if (userFeedback?.rating) {
    updateStars(container.querySelector(".stars"), userFeedback.rating);
  }
}

// ü™Ñ Toggle bookmark
async function toggleBookmark(user, adviceId, btn) {
  const bookmarkRef = doc(db, "users", user.uid, "bookmarks", adviceId);
  const snap = await getDoc(bookmarkRef);

  if (snap.exists()) {
    await deleteDoc(bookmarkRef);
    btn.textContent = "‚òÜ Bookmark";
  } else {
    await setDoc(bookmarkRef, { addedAt: new Date() });
    btn.textContent = "‚≠ê Bookmarked";
  }
}

async function updateAdvice(id) {
  const title = document.getElementById("advice-title").value.trim();
  const content = document.getElementById("advice-content").value.trim();
  const author = document.getElementById("advice-author").value.trim();
  const category = document.getElementById("advice-category").value.trim();

  if (!title || !content || !author) {
    alert("Please fill out all fields.");
    return;
  }

  try {
    await updateDoc(doc(db, "advice", id), {
      title,
      content,
      author,
      category,
      timestamp: new Date().toISOString(),
    });

    closeModal();
    loadAdvice(); // Refresh your advice list
  } catch (error) {
    console.error("Error updating advice:", error);
  }
}

function updateStars(container, rating) {
  const stars = container.querySelectorAll(".star");
  stars.forEach(star => {
    const value = parseInt(star.dataset.value);
    star.classList.toggle("selected", value <= rating);
  });
}

// üë• Handle auth state
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    document.getElementById("upload-section").style.display = user ? "block" : "none";
  if (user) {
    // User is logged in
    loginSection.style.display = "none";
    loggedInSection.style.display = "block";
    filters.classList.remove("hidden");
    loadAdvice(user);
  } else {
    // User is logged out
    loginSection.style.display = "block";
    loggedInSection.style.display = "none";
    filters.classList.add("hidden");
    adviceList.innerHTML = "<p>Please log in to view advice.</p>";
  }
});

document.getElementById("importCsvBtn").addEventListener("click", async () => {
  const fileInput = document.getElementById("csvFileInput");
  const status = document.getElementById("importStatus");
  const file = fileInput.files[0];
  
  if (!file) {
    status.textContent = "Please select a CSV file first.";
    return;
  }

  status.textContent = "Parsing file...";

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async (results) => {
      const data = results.data;
      let imported = 0;
      let skipped = 0;
      let errors = 0;

      status.textContent = `Checking ${data.length} rows for duplicates...`;

      for (const row of data) {
        try {
          // Validate required fields
          if (!row.title || !row.content) {
            console.warn("Missing title or content, skipping:", row);
            skipped++;
            continue;
          }

          // üîç Check if a doc with the same title + content already exists
          const q = query(
            collection(db, "advice"),
            where("title", "==", row.title),
            where("content", "==", row.content)
          );
          const snapshot = await getDocs(q);

          if (!snapshot.empty) {
            // Duplicate found
            skipped++;
            continue;
          }

          await addDoc(collection(db, "advice"), {
            title: row.title,
            content: row.content,
            author: row.author,
            category: row.category,
            authorId: currentUser ? currentUser.uid : null,
            timestamp: serverTimestamp()
          });
          imported++;
        } catch (err) {
          console.error("Error importing row:", err);
          errors++;
        }
      }

      status.textContent = `Import complete! Imported: ${imported}, Skipped (duplicates/missing): ${skipped}, Errors: ${errors}`;
    },
    error: (err) => {
      console.error("Parse error:", err);
      status.textContent = "Error parsing CSV file.";
    }
  });
});

window.addEventListener("DOMContentLoaded", () => {
  loadCategories();
  applyFilters();
});

// Handle manual comment saving
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('save-feedback-btn')) {
    const section = e.target.closest('.feedback-section');
    const adviceId = section.dataset.adviceId;
    const commentInput = section.querySelector('.comment-input');
    const comment = commentInput.value.trim();
    const userId = currentUser?.uid;
    const userName = currentUser?.displayName || currentUser?.email || "Anonymous";

    if (!userId) {
      alert("Please log in to leave a comment.");
      return;
    }
    if (!comment) {
      alert("Please write a comment first!");
      return;
    }

    try {
      // Save comment (without changing rating)
      await saveFeedback(adviceId, userId, null, comment, userName);
      commentInput.value = "";
      showFeedback(adviceId, section); // refresh immediately
    } catch (err) {
      console.error("Error saving comment:", err);
    }
  }
});

const adviceForm = document.getElementById("advice-form");

adviceForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('advice-title').value.trim();
  const content = document.getElementById('advice-content').value.trim();
  const author = document.getElementById('advice-author').value.trim();
  const category = document.getElementById('advice-category').value.trim();

  if (!title || !content) {
    alert("Title and content are required.");
    return;
  }

  try {
    if (editingAdviceId) {
      // ‚úèÔ∏è Update existing advice
      await setDoc(doc(db, "advice", editingAdviceId), {
        title,
        content,
        author,
        category,
        authorId: currentUser ? currentUser.uid : null,
        timestamp: serverTimestamp()
      }, { merge: true });

      editingAdviceId = null; // reset edit mode
    } else {
      // ‚ûï Add new advice
      await addDoc(collection(db, "advice"), {
        title,
        content,
        author: author || (currentUser ? currentUser.email : null),
        authorId: currentUser ? currentUser.uid : null,
        category: category || "Uncategorized",
        timestamp: serverTimestamp()
      });
    }

    modal.style.display = "none";
    loadAdvice(currentUser);
  } catch (e) {
    console.error("Error saving advice:", e);
    alert("Error saving advice. See console for details.");
  }
});

document.getElementById("load-more-btn").addEventListener("click", loadMoreAdvice);

openBtn.addEventListener("click", () => {
  modal.style.display = "block";
  document.getElementById("advice-title").focus();
});

closeBtn.addEventListener("click", () => {
  modal.style.display = "none";
});

// Optional: close if user clicks outside modal box
window.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
  }
});

</script>
  <style>
input, textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}

button {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background-color: #0056b3;
}

body {
      font-family: system-ui, sans-serif;
      /* max-width: 700px; */
      margin: 40px auto;
      padding: 0 20px;
      background: #fafafa;
    }
    h1 { text-align: center; }
    .advice-item {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      margin: 0 0 8px;
    }
    p { margin: 6px 0; }
    #toggle-view {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    #toggle-view:hover {
      background-color: #5a6268;
    }
    .bookmark-btn {
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      color: #ff9800;
      margin-top: 6px;
    }
    .bookmark-btn:hover {
      transform: scale(1.05);
    }
    #add-advice-section {
      display: none;
    }

    .view-btn {
  padding: 8px 16px;
  margin-right: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f4f4f4;
  color: #333;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s, border-color 0.2s;
}

.view-btn:hover:not(:disabled) {
  background-color: #e4e4e4;
}

.view-btn:disabled {
  opacity: 1; /* keep readable */
  cursor: not-allowed;
}

/* Selected (active) state */
#view-buttons .view-btn.selected,
#view-buttons .view-btn.selected:disabled {
  background-color: #cce5ff !important; /* light blue background */
  color: #004085 !important;            /* dark blue text */
  border-color: #66b0ff !important;     /* slightly brighter border */
  font-weight: 600;
}

#category-select {
  padding: 8px 16px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f4f4f4;
  cursor: pointer;
}

#category-select:hover {
  background-color: #e4e4e4;
}

.star {
  font-size: 20px;
  color: gray;
  cursor: pointer;
}
.star.selected {
  color: gold;
}
.feedback-section {
  margin-top: 8px;
}
.comment-input {
  display: block;
  width: 100%;
  margin-top: 4px;
  padding: 4px;
}

.delete-btn {
  background: none;
  border: none;
  color: #e74c3c;
  cursor: pointer;
  margin-left: 8px;
  font-size: 14px;
}
.delete-btn:hover {
  transform: scale(1.05);
  color: #c0392b;
}

.edit-btn {
  background: none;
  border: none;
  color: #e74c3c;
  cursor: pointer;
  margin-left: 8px;
  font-size: 14px;
}
.edit-btn:hover {
  transform: scale(1.05);
  color: #c0392b;
}

#filters {
  display: flex;
  align-items: center;
  gap: 16px; /* space between filters */
  margin-bottom: 16px;
  flex-wrap: wrap; /* so it wraps gracefully on small screens */
}

#filters input[type="checkbox"] {
  margin-right: 6px;
}

#filters label,
#filters select {
  font-size: 14px;
}

.hidden {
  display: none !important;
}

#content-wrapper {
  display: flex;
  height: 60vh; /* Adjust this value (e.g., 70vh or 500px) based on your page's header height and testing. This limits the container so columns can scroll independently. */
  border: 1px solid #ccc; /* Optional: Adds a subtle border around the whole container for visual separation. */
  border-radius: 10px;
  overflow: hidden; /* Prevents any overflow from spilling outside the container. */
  background: #fff; /* Matches your existing advice-item background for consistency. */
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* Matches your existing shadow for consistency. */
}

#sidebar {
  width: 250px; /* Fixed width for the sidebar. Adjust if needed (e.g., 20% for responsiveness). */
  overflow-y: auto; /* Enables vertical scrolling if filters grow long. */
  padding: 15px;
  background: #f0f0f0; /* Light gray background to distinguish the sidebar. */
  border-right: 1px solid #ccc; /* Separator line between sidebar and main content. */
  box-sizing: border-box; /* Ensures padding doesn't add to width. */
}

#main-content {
  flex: 1; /* Takes up the remaining space. */
  overflow-y: auto; /* Enables vertical scrolling for the advice list. */
  padding: 15px;
  box-sizing: border-box; /* Ensures padding doesn't add to width. */
}

/* Optional: Make the layout responsive on smaller screens (e.g., mobile) */
@media (max-width: 768px) {
  #content-wrapper {
    flex-direction: column; /* Stack sidebar on top of main content on small screens. */
    height: auto; /* Remove fixed height so it flows naturally. */
  }
  #sidebar {
    width: 100%; /* Full width on mobile. */
    border-right: none;
    border-bottom: 1px solid #ccc;
  }
}

.category-label {
  font-size: 12px;
  color: #666;
  background-color: #f5f5f5;
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  margin-top: 4px;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
}
.category-label:hover {
  background-color: #e6f0ff;
  color: #004085;
}

#category-links-container {
  margin-top: 10px;
}

#category-links {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.category-link {
  text-decoration: none;
  color: #007bff;
  font-size: 14px;
  transition: color 0.2s;
}

.category-link:hover {
  color: #0056b3;
  text-decoration: underline;
}

.category-link.active {
  font-weight: bold;
  color: #004085;
  text-decoration: underline;
}

/* Modal background */
.modal {
  display: none; /* Hidden by default */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
}

/* Modal box */
.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px 30px;
  border-radius: 10px;
  width: 400px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Close button */
.close-btn {
  float: right;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: #888;
}

.close-btn:hover {
  color: #000;
}

/* Trigger button */
.primary-btn {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}

.primary-btn:hover {
  background-color: #0056b3;
}

  </style>
</head>
<body>
  <h1>Advice Board</h1>

<!-- LOGIN FORM (shown when logged out) -->
<div id="app"></div>
<div id="login-section">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="login">Log In</button>
  <button id="signup">Sign Up</button>
</div>

<!-- LOGGED-IN CONTROLS -->
<div id="logged-in-section" style="display:none;">
  <p id="status"></p>
  <button id="open-add-advice" class="primary-btn">Add Advice</button>
  <button id="logout">Log Out</button>
</div>

<!-- ADVICE MODAL (used for both Add and Edit) -->
<div id="advice-modal" class="modal">
  <div class="modal-content">
    <span id="close-modal" class="close">&times;</span>
    <h2 id="modal-title">Add Advice</h2>
    <form id="advice-form">
      <input type="text" id="advice-title" placeholder="Title" />
      <textarea id="advice-content" placeholder="Content"></textarea>
      <input type="text" id="advice-author" placeholder="Author" />
      <input type="text" id="advice-category" placeholder="Category" />
      <button id="submit-advice-btn">Add Advice</button>
    </form>
  </div>
</div>
<hr>

<div id="content-wrapper">
  <div id="sidebar">
    <div id="upload-section" style="margin-top:20px;">
      <h2>Import</h2>
      <input type="file" id="csvFileInput" accept=".csv">
      <button id="importCsvBtn">Import to Firestore</button>
      <p id="importStatus"></p>
    </div>
    <h2>Filters</h2> <!-- Optional: Adds a heading to the sidebar for clarity -->
    <div id="filters">
      <label><input type="checkbox" id="filter-my"> Added By Me</label>
      <label><input type="checkbox" id="filter-bookmarked"> Bookmarked</label>
      <div id="category-links-container">
        <p style="font-weight:bold;">Categories</p>
        <div id="category-links">
          <!-- category links will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>
  <div id="main-content">
    <h2>Advice Board</h2>
    <div id="advice-list"></div>
    <div style="text-align:center; margin: 20px 0;">
      <button id="load-more-btn" style="display:none;">Load More</button>
    </div>
  </div>
</div>
<script type="module" src="./app.js"></script>
</body>
</html>
